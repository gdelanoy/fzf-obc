#!/usr/bin/env bash
_filedir()
{
  local IFS=$'\n'

  local cur="${cur}"
  __fzf_obc_tilde "${cur%%\**}" || return

  if [[ "$1" != -d ]]; then
  local xspec
  [[ ${BASH_VERSINFO[0]} -ge 4 ]] && xspec="${1:+*.@($1|${1^^})}" || xspec="${1:+*.@($1|$(printf %s "$1" | tr '[:lower:]' '[:upper:]'))}";

    __fzf_add2compreply < <(__fzf_obc_search "${cur}" "paths" "${xspec}")
    [[ -n ${COMP_FILEDIR_FALLBACK:-} && -n "$1" && ${#COMPREPLY[@]} -lt 1 ]] && __fzf_add2compreply < <(__fzf_obc_search "${cur}" "paths")
  else
    __fzf_add2compreply < <(__fzf_obc_search "${cur}" "dirs")
  fi

  if [[ "${#COMPREPLY[@]}" -gt 0 ]];then
    type compopt >&/dev/null && compopt -o filenames 2> /dev/null || compgen -f /non-existing-dir/ > /dev/null
  fi

  return 0
}
